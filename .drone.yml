---
kind: pipeline
name: default

steps:
  ## Pull the last build .m2 from GCloud bucket
  - &cache
    name: restore-cache
    image: homerovalle/drone-gcs-cache
    settings:
      &cache-settings
      pull: true
      bucket: drone-agent-m2-cache
      json_key:
        from_secret: gcloud_bucket_access_key_json
      restore: true
      debug: true

  ## Run the build
  - name: build-artifacts
    pull: default
    image: maven:3.6.2-jdk-8
    commands:
      # Import PGP keys
      - export GPG_TTY=/dev/console
      - env
      - echo "$${GPG_SECRET_KEYS}"
      - echo "$${GPG_OWNERTRUST}"

      - echo "$${GPG_SECRET_KEYS}" | base64 --decode | gpg --import --batch
      - echo "$${GPG_OWNERTRUST}" | base64 --decode | gpg --import-ownertrust

      # Run maven build
      - mvn -B -s /drone/src/.maven.xml clean package
    environment:
      SONATYPE_USERNAME:
        from_secret: sonatype_username
      M2_HOME: /drone/.m2
      MAVEN_HOME: /drone/.m2
      MAVEN_OPTS:
        -Dstyle.color=always
        -Djansi.force=true
        -Dorg.apache.maven.user-settings=/drone/src/.maven.xml
        -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
        -Dorg.ops4j.pax.url.mvn.settings=/drone/src/.maven.xml
        -DuseCustomSettings=true

    secrets: [ sonatype_username, sonatype_password, gpg_keyname, gpg_executable, gpg_passphrase, gpg_secret_keys, gpg_ownertrust, github_access_token, blackbelt_nexus_username, blackbelt_nexus_password]
    when:
      event:
        - push
        - pull_request

  ## Push the current .m2 cache to GCloud bucket
  - <<: *cache
    name: rebuild-cache
    settings:
      <<: *cache-settings
      rebuild: true
      restore: false
      mount:
        - .m2
      when:
        status:
        - success
        - failure
        
  ## Flush the old .m2 cache from GCloud bucket
  - <<: *cache
    name: flush_cache
    settings:
      <<: *cache-settings
      restore: false
      flush: true
      flush_age: 31

